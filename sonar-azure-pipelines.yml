trigger:
  branches:
    include:
      - main

pool:
  name: 'azureagent'   # your self-hosted Linux agent

variables:
  SONARQUBE_SERVICE: 'sonarqube-connection'
  system.debug: 'true'  # verbose logs for Sonar tasks

stages:
- stage: Python_Analysis
  displayName: "Python Frontend - SonarQube Analysis"
  jobs:
  - job: PythonFrontend
    displayName: "Analyze Python Frontend"
    steps:
    - checkout: self

    # --- Java is required by SonarScanner ---
    - script: |
        set -eux
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jre
        java -version
      displayName: "Install Java 17 (required for SonarScanner)"

    # --- Prepare SonarQube (CLI/Other mode) ---
    - task: SonarQubePrepare@7
      displayName: "Prepare SonarQube (Python via CLI)"
      inputs:
        SonarQube: $(SONARQUBE_SERVICE)
        scannerMode: "Other"             # CLI mode
        configMode: "manual"
        cliProjectKey: "vote-frontend-python"
        cliProjectName: "vote-frontend-python"
        extraProperties: |
          # Keep everything anchored at repo root
          sonar.projectBaseDir=$(Build.SourcesDirectory)
          sonar.sources=vote
          sonar.exclusions=**/__pycache__/**,**/venv/**,**/.venv/**,**/.tox/**
          sonar.python.coverage.reportPaths=vote/coverage.xml
          sonar.python.version=3.10
          # Optional if you use branches
          sonar.branch.name=$(Build.SourceBranchName)

    # --- Verify repo layout ---
    - script: |
        set -eux
        echo "Repo root: $(Build.SourcesDirectory)"
        ls -la "$(Build.SourcesDirectory)"
        test -d "$(Build.SourcesDirectory)/vote" || (echo "ERROR: vote/ not found at repo root" && exit 1)
      displayName: "Verify sources directory exists"

    # --- Ensure Python ---
    - script: |
        set -eux
        sudo apt-get update
        sudo apt-get install -y python3 python3-venv python3-pip
        python3 --version
        pip3 --version
      displayName: "Ensure Python & pip are installed"

    # --- Create venv, install deps, run tests & coverage (stay in repo root) ---
    - script: |
        set -euxo pipefail
        cd "$(Build.SourcesDirectory)"
        python3 -m venv .venv
        . .venv/bin/activate
        python -m pip install --upgrade pip
        if [ -f vote/requirements.txt ]; then
          python -m pip install -r vote/requirements.txt
        fi
        python -m pip install pytest pytest-cov
        echo "Running pytest for vote/ with coverage..."
        pytest vote -q --maxfail=1 --disable-warnings --cov=vote --cov-report=xml:vote/coverage.xml || echo "pytest failed or no tests discovered; continuing"
        if [ -f vote/coverage.xml ]; then
          echo "coverage.xml generated at vote/coverage.xml"
        else
          echo "WARNING: vote/coverage.xml not generated (analysis will still proceed without coverage)"
        fi
      displayName: "Run Python tests (root, target vote/)"

    # --- IMPORTANT: Recursively hide Maven/Gradle files anywhere in the repo ---
    - script: |
        set -euxo pipefail
        cd "$(Build.SourcesDirectory)"
        HIDE_DIR=".sonar_tmp_hide"
        rm -rf "$HIDE_DIR"
        mkdir -p "$HIDE_DIR"

        # Find typical Maven/Gradle files anywhere below the repo root.
        # Adjust patterns if you have additional build files.
        mapfile -d '' FILES < <(find "$(pwd)" -type f \( \
            -name "pom.xml" -o \
            -name "build.gradle" -o \
            -name "build.gradle.kts" -o \
            -name "settings.gradle" -o \
            -name "settings.gradle.kts" -o \
            -name "gradle.properties" \
          \) -print0)

        if [ "${#FILES[@]}" -gt 0 ]; then
          echo "Hiding ${#FILES[@]} Maven/Gradle file(s)..."
          for SRC in "${FILES[@]}"; do
            # Keep relative path under HIDE_DIR for safe restoration
            REL="${SRC#$(pwd)/}"
            DEST="$HIDE_DIR/$REL"
            mkdir -p "$(dirname "$DEST")"
            mv "$SRC" "$DEST"
            echo "  hid: $REL"
          done
        else
          echo "No Maven/Gradle files found to hide."
        fi
      displayName: "Recursively hide Maven/Gradle files (monorepo guard)"

    # --- Run analysis via the ADO task (uses service connection) ---
    - task: SonarQubeAnalyze@7
      displayName: "Run SonarQube Analysis (Python)"

    # --- Restore all hidden files immediately after analysis ---
    - script: |
        set -euxo pipefail
        cd "$(Build.SourcesDirectory)"
        HIDE_DIR=".sonar_tmp_hide"
        if [ -d "$HIDE_DIR" ]; then
          echo "Restoring hidden Maven/Gradle files..."
          # Restore in reverse depth order so directories exist
          mapfile -d '' RESTORE < <(find "$HIDE_DIR" -type f -print0 | sort -rz)
          for SRC in "${RESTORE[@]}"; do
            REL="${SRC#$HIDE_DIR/}"
            DEST="$(pwd)/$REL"
            mkdir -p "$(dirname "$DEST")"
            mv "$SRC" "$DEST"
            echo "  restored: $REL"
          done
          rmdir "$HIDE_DIR" || true
        else
          echo "No hidden files to restore."
        fi
      displayName: "Restore Maven/Gradle files"

    # --- Verify report-task.txt exists; fail fast if missing ---
    - script: |
        set -euxo pipefail
        echo "Searching for report-task.txt..."
        FOUND=""
        CANDIDATES="$(Build.SourcesDirectory)/.scannerwork/report-task.txt
        $(Agent.TempDirectory)/.sonarqube/out/.sonar/report-task.txt"
        for f in $CANDIDATES; do
          if [ -f "$f" ]; then
            echo "Found report-task.txt at: $f"
            sed -n '1,160p' "$f" || true
            FOUND="$f"
          fi
        done
        if [ -z "$FOUND" ]; then
          echo "report-task.txt not found in common locations. Broad search follows:"
          find "$(Build.SourcesDirectory)" "$(Agent.TempDirectory)" -maxdepth 10 -type f -name "report-task.txt" -print -exec sed -n '1,160p' {} \; || true
          echo "ERROR: SonarQube analysis did not produce report-task.txt; cannot publish Quality Gate for this build."
          exit 1
        fi
      displayName: "Verify analysis output (report-task.txt)"

    # --- Publish Quality Gate ---
    - task: SonarQubePublish@7
      displayName: "Publish Quality Gate (Python)"
      inputs:
        pollingTimeoutSec: "300"