trigger:
  branches:
    include:
      - main

pool:
  name: 'azureagent'   # your self-hosted Linux agent pool

variables:
  SONARQUBE_SERVICE: 'sonarqube-connection'   # your SonarQube service connection name

stages:
# ============================
#  PYTHON FRONTEND ANALYSIS
# ============================
- stage: Python_Analysis
  displayName: "Python Frontend - SonarQube Analysis"
  jobs:
  - job: PythonFrontend
    displayName: "Analyze Python Frontend"
    steps:
    - checkout: self

    # --- Java is required for SonarScanner CLI ---
    - script: |
        set -eux
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jre
        java -version
      displayName: "Install Java 17 (required for SonarScanner)"

    # --- Prepare SonarQube (CLI/Other mode) ---
    - task: SonarQubePrepare@7
      displayName: "Prepare SonarQube (Python via CLI)"
      inputs:
        SonarQube: $(SONARQUBE_SERVICE)
        scannerMode: "Other"             # CLI mode
        configMode: "manual"
        cliProjectKey: "vote-frontend-python"
        cliProjectName: "vote-frontend-python"
        extraProperties: |
          sonar.projectBaseDir=$(Build.SourcesDirectory)
          sonar.sources=vote
          sonar.exclusions=**/__pycache__/**,**/venv/**,**/.venv/**,**/.tox/**
          sonar.python.coverage.reportPaths=vote/coverage.xml
          sonar.python.version=3.10
          # (Optional) if you use branches:
          sonar.branch.name=$(Build.SourceBranchName)

    # --- Verify sources exist ---
    - script: |
        set -e
        echo "Verifying source layout..."
        ls -la "$(Build.SourcesDirectory)"
        test -d "$(Build.SourcesDirectory)/vote" || (echo "ERROR: vote/ not found at repo root" && exit 1)
      displayName: "Verify sources directory exists"

    # --- Ensure Python is available ---
    - script: |
        set -eux
        sudo apt-get update
        sudo apt-get install -y python3 python3-venv python3-pip
        python3 --version
        pip3 --version
      displayName: "Ensure Python & pip are installed"

    # --- Create venv, install deps, run tests, generate coverage ---
    # Stay in repo root; target vote/ explicitly to avoid dir drift.
    - script: |
        set -euxo pipefail
        cd "$(Build.SourcesDirectory)"
        python3 -m venv .venv
        . .venv/bin/activate
        python -m pip install --upgrade pip
        if [ -f vote/requirements.txt ]; then
          python -m pip install -r vote/requirements.txt
        fi
        python -m pip install pytest pytest-cov
        echo "Running tests for vote/ with coverage..."
        pytest vote -q --maxfail=1 --disable-warnings --cov=vote --cov-report=xml:vote/coverage.xml || echo "pytest failed or no tests discovered; continuing"
        if [ -f vote/coverage.xml ]; then
          echo "coverage.xml generated at vote/coverage.xml"
        else
          echo "WARNING: vote/coverage.xml not generated (analysis will still proceed)"
        fi
      displayName: "Run Python tests (stay in repo root)"

    # --- IMPORTANT: Avoid Analyze task's Maven/Gradle short-circuit in monorepo ---
    # Temporarily move root-level Maven/Gradle files out of the way.
    - script: |
        set -eux
        cd "$(Build.SourcesDirectory)"
        mkdir -p .sonar_tmp_hide
        # Only move root-level files; adjust the list if needed.
        for f in pom.xml build.gradle build.gradle.kts settings.gradle settings.gradle.kts gradle.properties; do
          if [ -f "$f" ]; then
            mv "$f" ".sonar_tmp_hide/$f"
            echo "Temporarily hid $f"
          fi
        done
      displayName: "Temporarily hide root Maven/Gradle files (monorepo guard)"

    # --- Run Code Analysis via the Azure DevOps task ---
    - task: SonarQubeAnalyze@7
      displayName: "Run SonarQube Analysis (Python)"

    # --- Restore the build files immediately after analysis ---
    - script: |
        set -eux
        cd "$(Build.SourcesDirectory)"
        if [ -d .sonar_tmp_hide ]; then
          for f in pom.xml build.gradle build.gradle.kts settings.gradle settings.gradle.kts gradle.properties; do
            if [ -f ".sonar_tmp_hide/$f" ]; then
              mv ".sonar_tmp_hide/$f" "$f"
              echo "Restored $f"
            fi
          done
          rmdir .sonar_tmp_hide || true
        fi
      displayName: "Restore Maven/Gradle files"

    # --- Debug: show where the scanner wrote report-task.txt ---
    - script: |
        set -eux
        echo "Searching for report-task.txt..."
        find "$(Build.SourcesDirectory)" "$(Agent.TempDirectory)" -maxdepth 8 -type f -name "report-task.txt" -print -exec sed -n '1,160p' {} \; || true
      displayName: "Debug: Show report-task.txt if present"

    # --- Publish Quality Gate ---
    - task: SonarQubePublish@7
      displayName: "Publish Quality Gate (Python)"
      inputs:
        pollingTimeoutSec: "300"