trigger:
  branches:
    include:
      - main

pool:
  name: 'azureagent'   # self-hosted agent pool

variables:
  SONARQUBE_SERVICE: 'sonarqube-connection'   # service connection name

stages:
- stage: Python_Analysis
  displayName: "Python Frontend - SonarQube Analysis"
  jobs:
  - job: PythonFrontend
    displayName: "Analyze Python Frontend"
    steps:
    - checkout: self

    # Java needed for SonarScanner CLI
    - script: |
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jre
        java -version
      displayName: "Install Java 17"

    - task: SonarQubePrepare@7
      displayName: "Prepare SonarQube (Python)"
      inputs:
        SonarQube: $(SONARQUBE_SERVICE)
        scannerMode: "Other"
        configMode: "manual"
        cliProjectKey: "vote-frontend-python"
        cliProjectName: "vote-frontend-python"
        extraProperties: |
          sonar.projectBaseDir=$(Build.SourcesDirectory)
          sonar.sources=vote
          sonar.exclusions=**/__pycache__/**,**/venv/**,**/.venv/**
          sonar.python.coverage.reportPaths=vote/coverage.xml
          sonar.python.version=3.10

    - script: |
        echo "Verifying sources..."
        ls -la $(Build.SourcesDirectory)
        test -d "$(Build.SourcesDirectory)/vote" || (echo "ERROR: vote/ not found" && exit 1)
      displayName: "Verify sources directory exists"

    - script: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-venv python3-pip
      displayName: "Ensure Python & venv are installed"

    # Keep execution in repo root; target vote/ explicitly
    - script: |
        set -e
        cd $(Build.SourcesDirectory)
        python3 -m venv .venv
        . .venv/bin/activate
        python -m pip install --upgrade pip
        if [ -f vote/requirements.txt ]; then
          python -m pip install -r vote/requirements.txt
        fi
        python -m pip install pytest pytest-cov
        echo "Running tests with coverage in vote/..."
        pytest vote -q --cov=vote --cov-report=xml:vote/coverage.xml || echo "pytest failed or no tests discovered; continuing"
        test -f vote/coverage.xml && echo "coverage.xml generated" || echo "No coverage.xml generated"
      displayName: "Run Python Tests (stay in root)"

    # (Optional) ensure we're at repo root (belt-and-braces)
    - script: |
        cd $(Build.SourcesDirectory)
        pwd
      displayName: "Confirm repo root for analysis"

    - task: SonarQubeAnalyze@7
      displayName: "Run SonarQube Analysis (Python)"

    - script: |
        echo "Searching for report-task.txt..."
        find $(Build.SourcesDirectory) -maxdepth 6 -type f -name "report-task.txt" -print -exec sed -n '1,120p' {} \; || true
      displayName: "Debug: Show report-task.txt if present"

    - task: SonarQubePublish@7
      displayName: "Publish Quality Gate (Python)"
      inputs:
        pollingTimeoutSec: "300"