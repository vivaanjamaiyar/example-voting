trigger:
  branches:
    include:
      - main

pool:
  name: 'azureagent'   # your self-hosted Linux agent pool

variables:
  SONARQUBE_SERVICE: 'sonarqube-connection'   # ADO service connection (used by Publish)
  SONAR_HOST_URL: 'http://74.242.168.143:9000'
  SONAR_TOKEN: 'sqa_744e33c00ce889d56e020391849fccc4a3236f79'
  system.debug: 'true'                        # verbose logs for Sonar tasks

stages:
- stage: Python_Analysis
  displayName: "Python Frontend - SonarQube Analysis"
  jobs:
  - job: PythonFrontend
    displayName: "Analyze Python Frontend"
    steps:
    - checkout: self

    # 0) Validate required variables and connectivity to SonarQube
    - script: |
        set -euo pipefail
        HOST="$(SONAR_HOST_URL)"
        TOKEN_PRESENT=""
        if [ -n "$(SONAR_TOKEN)" ]; then TOKEN_PRESENT="yes"; fi

        if [ -z "$HOST" ]; then
          echo "ERROR: Pipeline variable SONAR_HOST_URL is not set."
          echo "       Set it to your SonarQube URL, e.g. https://sonarqube.mycompany.com"
          exit 1
        fi
        if [ -z "$TOKEN_PRESENT" ]; then
          echo "ERROR: Pipeline secret SONAR_TOKEN is not set."
          echo "       Create a SonarQube token with Execute Analysis permission and add it as a secret variable."
          exit 1
        fi

        echo "Checking connectivity to: $HOST"
        STATUS=$(curl -sS -o /dev/null -w "%{http_code}" "$HOST/api/system/ping" || true)
        echo "Ping status: $STATUS"
        if [ "$STATUS" != "200" ]; then
          echo "WARNING: Ping didn't return 200. Trying /api/server/version with auth..."
          STATUS2=$(curl -sS -u "$(SONAR_TOKEN):" -o /dev/null -w "%{http_code}" "$HOST/api/server/version" || true)
          echo "Version status: $STATUS2"
          if [ "$STATUS2" != "200" ]; then
            echo "ERROR: Cannot reach SonarQube at $HOST from this agent."
            echo "       Check URL, firewall/proxy, or TLS certs. If behind a proxy, set https_proxy/http_proxy env vars."
            exit 1
          fi
        fi
      displayName: "Validate Sonar variables & connectivity"

    # 1) Install Java 21 (scanner requirement going forward)
    - script: |
        set -eux
        sudo apt-get update
        sudo apt-get install -y openjdk-21-jre curl unzip
        java -version
      displayName: "Install Java 21 and tools"

    # 2) Prepare (lets Publish know the server via the service connection)
    #    IMPORTANT: No sonar.branch.name here (Community Edition)
    - task: SonarQubePrepare@7
      displayName: "Prepare SonarQube (for Publish)"
      inputs:
        SonarQube: $(SONARQUBE_SERVICE)
        scannerMode: "Other"             # We'll run CLI manually
        configMode: "manual"
        cliProjectKey: "vote-frontend-python"
        cliProjectName: "vote-frontend-python"
        extraProperties: |
          sonar.projectBaseDir=$(Build.SourcesDirectory)
          sonar.sources=vote
          sonar.exclusions=**/__pycache__/**,**/venv/**,**/.venv/**,**/.tox/**
          sonar.python.coverage.reportPaths=vote/coverage.xml
          sonar.python.version=3.10

    # 3) Verify repo layout
    - script: |
        set -eux
        echo "Repo root: $(Build.SourcesDirectory)"
        ls -la "$(Build.SourcesDirectory)"
        test -d "$(Build.SourcesDirectory)/vote" || (echo "ERROR: vote/ not found at repo root" && exit 1)
      displayName: "Verify sources directory exists"

    # 4) Ensure Python
    - script: |
        set -eux
        sudo apt-get update
        sudo apt-get install -y python3 python3-venv python3-pip
        python3 --version
        pip3 --version
      displayName: "Ensure Python & pip"

    # 5) Venv + tests + coverage (stay in repo root)
    - script: |
        set -euxo pipefail
        cd "$(Build.SourcesDirectory)"
        python3 -m venv .venv
        . .venv/bin/activate
        python -m pip install --upgrade pip
        if [ -f vote/requirements.txt ]; then
          python -m pip install -r vote/requirements.txt
        fi
        python -m pip install pytest pytest-cov
        echo "Running pytest for vote/ with coverage..."
        pytest vote -q --maxfail=1 --disable-warnings --cov=vote --cov-report=xml:vote/coverage.xml || echo "pytest failed or no tests discovered; continuing"
        if [ -f vote/coverage.xml ]; then
          echo "coverage.xml generated at vote/coverage.xml"
        else
          echo "WARNING: vote/coverage.xml not generated (analysis will proceed without coverage)"
        fi
      displayName: "Run Python tests (root, target vote/)"

    # 6) Download & run SonarScanner CLI (manual; ignore repo properties)
    - script: |
        set -euxo pipefail
        cd "$(Build.SourcesDirectory)"

        echo "Scanning repo for branch/PR properties (Community Edition does not allow these)..."
        grep -R --line-number -E '^\s*sonar\.branch\.name\s*=' . || true
        grep -R --line-number -E '^\s*sonar\.pullrequest\.' . || true

        SCANNER_VERSION="5.0.1.3006"
        SCANNER_DIR="$(Build.SourcesDirectory)/.scanner"
        mkdir -p "$SCANNER_DIR"
        curl -sSL -o "$SCANNER_DIR/sonar-scanner.zip" \
          "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SCANNER_VERSION}-linux.zip"
        unzip -q "$SCANNER_DIR/sonar-scanner.zip" -d "$SCANNER_DIR"
        SCANNER_BIN="$(find "$SCANNER_DIR" -type f -path "*/bin/sonar-scanner" | head -n1)"
        chmod +x "$SCANNER_BIN"

        # Provide an EMPTY project settings file so the scanner does NOT read repo props (e.g., sonar-project.properties)
        EMPTY_PROPS="$SCANNER_DIR/empty.properties"
        : > "$EMPTY_PROPS"

        echo "Running SonarScanner with an EMPTY project settings file to avoid branch/PR props from repo..."
        "$SCANNER_BIN" \
          -Dproject.settings="$EMPTY_PROPS" \
          -Dsonar.host.url="$(SONAR_HOST_URL)" \
          -Dsonar.login="$(SONAR_TOKEN)" \
          -Dsonar.projectKey="vote-frontend-python" \
          -Dsonar.projectBaseDir="$(Build.SourcesDirectory)" \
          -Dsonar.sources="vote" \
          -Dsonar.python.coverage.reportPaths="vote/coverage.xml"

        # Confirm report-task.txt
        REPORT_SRC="$(Build.SourcesDirectory)/.scannerwork/report-task.txt"
        if [ -f "$REPORT_SRC" ]; then
          echo "Found report-task.txt at $REPORT_SRC"
          sed -n '1,160p' "$REPORT_SRC" || true
        else
          echo "ERROR: report-task.txt not found at $REPORT_SRC"
          find "$(Build.SourcesDirectory)" -maxdepth 10 -type f -name "report-task.txt" -print -exec sed -n '1,160p' {} \; || true
          exit 1
        fi
      displayName: "Download & run SonarScanner CLI (manual, ignore repo props)"

    # 7) Copy report-task.txt where Publish expects it
    - script: |
        set -eux
        SRC="$(Build.SourcesDirectory)/.scannerwork/report-task.txt"
        DEST_DIR="$(Agent.TempDirectory)/.sonarqube/out/.sonar"
        mkdir -p "$DEST_DIR"
        cp "$SRC" "$DEST_DIR/report-task.txt"
        echo "Copied report-task.txt to $DEST_DIR"
      displayName: "Make report-task.txt visible to Publish"

    # 8) Publish Quality Gate
    - task: SonarQubePublish@7
      displayName: "Publish Quality Gate (Python)"
      inputs:
        pollingTimeoutSec: "300"