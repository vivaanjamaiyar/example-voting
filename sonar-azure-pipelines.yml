trigger:
  branches:
    include:
      - main

pool:
  name: 'azureagent'   # your self-hosted Linux agent

variables:
  SONARQUBE_SERVICE: 'sonarqube-connection'
  system.debug: 'true'  # enable verbose logs for Sonar tasks

stages:
- stage: Python_Analysis
  displayName: "Python Frontend - SonarQube Analysis"
  jobs:
  - job: PythonFrontend
    displayName: "Analyze Python Frontend"
    steps:
    - checkout: self

    # Java is required by SonarScanner
    - script: |
        set -eux
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jre
        java -version
      displayName: "Install Java 17"

    # Prepare in CLI/Other mode
    - task: SonarQubePrepare@7
      displayName: "Prepare SonarQube (Python via CLI)"
      inputs:
        SonarQube: $(SONARQUBE_SERVICE)
        scannerMode: "Other"
        configMode: "manual"
        cliProjectKey: "vote-frontend-python"
        cliProjectName: "vote-frontend-python"
        extraProperties: |
          sonar.projectBaseDir=$(Build.SourcesDirectory)
          sonar.sources=vote
          sonar.exclusions=**/__pycache__/**,**/venv/**,**/.venv/**,**/.tox/**
          sonar.python.coverage.reportPaths=vote/coverage.xml
          sonar.python.version=3.10
          # Optional if you use branches:
          sonar.branch.name=$(Build.SourceBranchName)

    # Verify repo layout
    - script: |
        set -eux
        echo "Repo root: $(Build.SourcesDirectory)"
        ls -la "$(Build.SourcesDirectory)"
        test -d "$(Build.SourcesDirectory)/vote" || (echo "ERROR: vote/ not found at repo root" && exit 1)
      displayName: "Verify sources directory exists"

    # Ensure Python
    - script: |
        set -eux
        sudo apt-get update
        sudo apt-get install -y python3 python3-venv python3-pip
        python3 --version
        pip3 --version
      displayName: "Ensure Python & pip are installed"

    # Create venv, install deps, run tests & coverage (stay in repo root)
    - script: |
        set -euxo pipefail
        cd "$(Build.SourcesDirectory)"
        python3 -m venv .venv
        . .venv/bin/activate
        python -m pip install --upgrade pip
        if [ -f vote/requirements.txt ]; then
          python -m pip install -r vote/requirements.txt
        fi
        python -m pip install pytest pytest-cov
        echo "Running pytest for vote/ with coverage..."
        pytest vote -q --maxfail=1 --disable-warnings --cov=vote --cov-report=xml:vote/coverage.xml || echo "pytest failed or no tests discovered; continuing"
        if [ -f vote/coverage.xml ]; then
          echo "coverage.xml generated at vote/coverage.xml"
        else
          echo "WARNING: vote/coverage.xml not generated (analysis will still proceed without coverage)"
        fi
      displayName: "Run Python tests (root, target vote/)"

    # Hide root Maven/Gradle files to prevent Analyze short-circuit in monorepos
    - script: |
        set -eux
        cd "$(Build.SourcesDirectory)"
        mkdir -p .sonar_tmp_hide
        for f in pom.xml build.gradle build.gradle.kts settings.gradle settings.gradle.kts gradle.properties; do
          if [ -f "$f" ]; then
            mv "$f" ".sonar_tmp_hide/$f"
            echo "Temporarily hid $f"
          fi
        done
      displayName: "Temporarily hide root Maven/Gradle files"

    # Run analysis via the ADO task (uses the service connection)
    - task: SonarQubeAnalyze@7
      displayName: "Run SonarQube Analysis (Python)"

    # Restore build files right after analyze
    - script: |
        set -eux
        cd "$(Build.SourcesDirectory)"
        if [ -d .sonar_tmp_hide ]; then
          for f in pom.xml build.gradle build.gradle.kts settings.gradle settings.gradle.kts gradle.properties; do
            if [ -f ".sonar_tmp_hide/$f" ]; then
              mv ".sonar_tmp_hide/$f" "$f"
              echo "Restored $f"
            fi
          done
          rmdir .sonar_tmp_hide || true
        fi
      displayName: "Restore Maven/Gradle files"

    # Assert/print report-task.txt â€“ FAIL the job if it's missing so we don't proceed to Publish with a confusing warning
    - script: |
        set -eux
        echo "Searching for report-task.txt..."
        FOUND=""
        # Two common locations to check
        CANDIDATES="$(Build.SourcesDirectory)/.scannerwork/report-task.txt
        $(Agent.TempDirectory)/.sonarqube/out/.sonar/report-task.txt"
        for f in $CANDIDATES; do
          if [ -f "$f" ]; then
            echo "Found report-task.txt at: $f"
            sed -n '1,160p' "$f" || true
            FOUND="$f"
          fi
        done
        # If not found, search more broadly and fail
        if [ -z "$FOUND" ]; then
          echo "report-task.txt not found in common locations. Broad search follows:"
          find "$(Build.SourcesDirectory)" "$(Agent.TempDirectory)" -maxdepth 10 -type f -name "report-task.txt" -print -exec sed -n '1,160p' {} \; || true
          echo "ERROR: SonarQube analysis did not produce report-task.txt; cannot publish Quality Gate for this build."
          exit 1
        fi
      displayName: "Verify analysis output (report-task.txt)"

    # Publish Quality Gate (now that report-task.txt is confirmed)
    - task: SonarQubePublish@7
      displayName: "Publish Quality Gate (Python)"
      inputs:
        pollingTimeoutSec: "300"