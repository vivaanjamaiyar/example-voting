trigger:
  branches:
    include:
      - main

pool:
  name: 'azureagent'   # your self-hosted agent pool

variables:
  SONARQUBE_SERVICE: 'sonarqube-connection'   # your connection name

stages:

# ============================
#  PYTHON FRONTEND ANALYSIS
# ============================
- stage: Python_Analysis
  displayName: "Python Frontend - SonarQube Analysis"
  jobs:
  - job: PythonFrontend
    displayName: "Analyze Python Frontend"
    steps:
    - checkout: self

    - script: |
        echo "Folders under repo:"
        ls -la
        echo "Contents of vote/:"
        ls -la vote || true
      displayName: "Debug Listing"

    - task: SonarQubePrepare@7
      displayName: "Prepare SonarQube (Python)"
      inputs:
        SonarQube: $(SONARQUBE_SERVICE)
        scannerMode: "Other"
        configMode: "manual"
        cliProjectKey: "vote-frontend-python"
        cliProjectName: "vote-frontend-python"
        extraProperties: |
          sonar.sources=vote
          sonar.exclusions=**/__pycache__/**,**/venv/**,**/.venv/**
          sonar.python.coverage.reportPaths=vote/coverage.xml

    # Ensure venv support is present (one-time; safe to run)
    - script: |
        sudo apt-get update
        sudo apt-get install -y python3 python3-venv python3-pip
      displayName: "Ensure Python & venv are installed"

    - script: |
        cd $(Build.SourcesDirectory)
        python3 -m venv .venv
        source .venv/bin/activate
        python -m pip install --upgrade pip
        python -m pip install -r vote/requirements.txt
        python -m pip install pytest pytest-cov
        pytest -q vote/tests --cov=vote --cov-report=xml:vote/coverage.xml
      displayName: "Run Python Tests in venv"

    - task: SonarQubeAnalyze@7
      displayName: "Run SonarQube Analysis (Python)"

    - task: SonarQubePublish@7
      displayName: "Publish Quality Gate (Python)"
      inputs:
        pollingTimeoutSec: "300"


# ============================
#  DOTNET WORKER ANALYSIS
# ============================
- stage: DotNet_Analysis
  displayName: ".NET Worker - SonarQube Analysis"
  jobs:
  - job: DotNetWorker
    displayName: "Analyze .NET Worker Service"
    steps:

    - checkout: self

    - script: |
        echo "Contents of worker/:"
        ls -la worker
      displayName: "Debug worker folder"

    - task: SonarQubePrepare@7
      displayName: "Prepare SonarQube (.NET)"
      inputs:
        SonarQube: $(SONARQUBE_SERVICE)
        scannerMode: "MSBuild"
        projectKey: "vote-worker-dotnet"
        projectName: "vote-worker-dotnet"
        extraProperties: |
          sonar.cs.opencover.reportsPaths=$(Build.SourcesDirectory)/worker/TestResults/coverage.opencover.xml

    - script: |
        sudo apt-get update
        sudo apt-get install -y dotnet-sdk-8.0
        dotnet restore worker
        dotnet build worker --configuration Release
        dotnet test worker --configuration Release \
            /p:CollectCoverage=true \
            /p:CoverletOutput=$(Build.SourcesDirectory)/worker/TestResults/coverage.opencover.xml \
            /p:CoverletOutputFormat=opencover
      displayName: "Build & Test (.NET)"

    - task: SonarQubeAnalyze@7
      displayName: "Run SonarQube Analysis (.NET)"

    - task: SonarQubePublish@7
      displayName: "Publish Quality Gate (.NET)"
      inputs:
        pollingTimeoutSec: "300"


# ============================
#  NODE.JS RESULTS ANALYSIS
# ============================
- stage: Node_Analysis
  displayName: "Node.js Results App - SonarQube Analysis"
  jobs:
  - job: NodeResults
    displayName: "Analyze Node.js Results App"
    steps:

    - checkout: self

    - script: |
        echo "Contents of result/:"
        ls -la result
      displayName: "Debug result folder"

    - task: SonarQubePrepare@7
      displayName: "Prepare SonarQube (Node)"
      inputs:
        SonarQube: $(SONARQUBE_SERVICE)
        scannerMode: "Other"
        configMode: "manual"
        cliProjectKey: "vote-results-node"
        cliProjectName: "vote-results-node"
        extraProperties: |
          sonar.sources=result
          sonar.exclusions=**/node_modules/**,**/dist/**,**/build/**
          sonar.javascript.lcov.reportPaths=result/coverage/lcov.info

    - script: |
        sudo apt-get update
        sudo apt-get install -y nodejs npm
        cd result
        npm install     # using install instead of ci because you likely donâ€™t have package-lock.json
        npm test -- --coverage
      displayName: "Install Node Modules & Run Tests"

    - task: SonarQubeAnalyze@7
      displayName: "Run SonarQube Analysis (Node)"

    - task: SonarQubePublish@7
      displayName: "Publish Quality Gate (Node)"
      inputs:
        pollingTimeoutSec: "300"